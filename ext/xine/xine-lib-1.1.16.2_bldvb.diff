diff -Nupr xine-lib-1.1.16.2-original/configure xine-lib-1.1.16.2-modified/configure
--- xine-lib-1.1.16.2-original/configure	2009-02-10 19:35:05.000000000 +0100
+++ xine-lib-1.1.16.2-modified/configure	2009-05-25 13:19:26.000000000 +0200
@@ -938,6 +938,10 @@ HAVE_MLIB_TRUE
 HAVE_MLIB_FALSE
 MLIB_LIBS
 MLIB_CFLAGS
+HAVE_LIBMEDIACLIENT_TRUE
+HAVE_LIBMEDIACLIENT_FALSE
+LIBMEDIACLIENT_CFLAGS
+LIBMEDIACLIENT_LIBS
 X_CFLAGS
 X_LIBS
 XMKMF
@@ -1916,6 +1920,7 @@ Optional Features:
   --disable-vis           do not use assembly codes for Sun UltraSPARC CPUs
   --enable-mlib           build Sun mediaLib support
   --enable-mlib-lazyload  check for Sun mediaLib at runtime
+  --enable-libmediaclient build em28xx libmediaclient support
   --enable-ipv6           enable use of IPv6
   --disable-opengl        do not build OpenGL plugin
   --disable-glu           build OpenGL plugin without GLU (no verbose errors)
@@ -6110,7 +6115,7 @@ fi
 enable_win32_dll=yes
 
 case $host in
-*-*-cygwin* | *-*-mingw* | *-*-pw32* | *-cegcc*)
+*-*-cygwin* | *-*-mingw* | *-*-pw32*)
   if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}as", so it can be a program name with args.
 set dummy ${ac_tool_prefix}as; ac_word=$2
@@ -6430,8 +6435,8 @@ esac
 
 
 
-macro_version='2.2.6'
-macro_revision='1.3012'
+macro_version='2.2.4'
+macro_revision='1.2976'
 
 
 
@@ -6938,13 +6943,13 @@ if test "${lt_cv_nm_interface+set}" = se
 else
   lt_cv_nm_interface="BSD nm"
   echo "int some_variable = 0;" > conftest.$ac_ext
-  (eval echo "\"\$as_me:6941: $ac_compile\"" >&5)
+  (eval echo "\"\$as_me:6946: $ac_compile\"" >&5)
   (eval "$ac_compile" 2>conftest.err)
   cat conftest.err >&5
-  (eval echo "\"\$as_me:6944: $NM \\\"conftest.$ac_objext\\\"\"" >&5)
+  (eval echo "\"\$as_me:6949: $NM \\\"conftest.$ac_objext\\\"\"" >&5)
   (eval "$NM \"conftest.$ac_objext\"" 2>conftest.err > conftest.out)
   cat conftest.err >&5
-  (eval echo "\"\$as_me:6947: output\"" >&5)
+  (eval echo "\"\$as_me:6952: output\"" >&5)
   cat conftest.out >&5
   if $GREP 'External.*some_variable' conftest.out > /dev/null; then
     lt_cv_nm_interface="MS dumpbin"
@@ -6979,7 +6984,7 @@ else
     lt_cv_sys_max_cmd_len=-1;
     ;;
 
-  cygwin* | mingw* | cegcc*)
+  cygwin* | mingw*)
     # On Win9x/ME, this test blows up -- it succeeds, but takes
     # about 5 minutes as the teststring grows exponentially.
     # Worse, since 9x/ME are not pre-emptively multitasking,
@@ -7180,108 +7185,6 @@ esac
 
 
 
-if test -n "$ac_tool_prefix"; then
-  # Extract the first word of "${ac_tool_prefix}objdump", so it can be a program name with args.
-set dummy ${ac_tool_prefix}objdump; ac_word=$2
-{ echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6; }
-if test "${ac_cv_prog_OBJDUMP+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
-else
-  if test -n "$OBJDUMP"; then
-  ac_cv_prog_OBJDUMP="$OBJDUMP" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_OBJDUMP="${ac_tool_prefix}objdump"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-done
-IFS=$as_save_IFS
-
-fi
-fi
-OBJDUMP=$ac_cv_prog_OBJDUMP
-if test -n "$OBJDUMP"; then
-  { echo "$as_me:$LINENO: result: $OBJDUMP" >&5
-echo "${ECHO_T}$OBJDUMP" >&6; }
-else
-  { echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6; }
-fi
-
-
-fi
-if test -z "$ac_cv_prog_OBJDUMP"; then
-  ac_ct_OBJDUMP=$OBJDUMP
-  # Extract the first word of "objdump", so it can be a program name with args.
-set dummy objdump; ac_word=$2
-{ echo "$as_me:$LINENO: checking for $ac_word" >&5
-echo $ECHO_N "checking for $ac_word... $ECHO_C" >&6; }
-if test "${ac_cv_prog_ac_ct_OBJDUMP+set}" = set; then
-  echo $ECHO_N "(cached) $ECHO_C" >&6
-else
-  if test -n "$ac_ct_OBJDUMP"; then
-  ac_cv_prog_ac_ct_OBJDUMP="$ac_ct_OBJDUMP" # Let the user override the test.
-else
-as_save_IFS=$IFS; IFS=$PATH_SEPARATOR
-for as_dir in $PATH
-do
-  IFS=$as_save_IFS
-  test -z "$as_dir" && as_dir=.
-  for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
-    ac_cv_prog_ac_ct_OBJDUMP="objdump"
-    echo "$as_me:$LINENO: found $as_dir/$ac_word$ac_exec_ext" >&5
-    break 2
-  fi
-done
-done
-IFS=$as_save_IFS
-
-fi
-fi
-ac_ct_OBJDUMP=$ac_cv_prog_ac_ct_OBJDUMP
-if test -n "$ac_ct_OBJDUMP"; then
-  { echo "$as_me:$LINENO: result: $ac_ct_OBJDUMP" >&5
-echo "${ECHO_T}$ac_ct_OBJDUMP" >&6; }
-else
-  { echo "$as_me:$LINENO: result: no" >&5
-echo "${ECHO_T}no" >&6; }
-fi
-
-  if test "x$ac_ct_OBJDUMP" = x; then
-    OBJDUMP="false"
-  else
-    case $cross_compiling:$ac_tool_warned in
-yes:)
-{ echo "$as_me:$LINENO: WARNING: In the future, Autoconf will not detect cross-tools
-whose name does not start with the host triplet.  If you think this
-configuration is useful to you, please write to autoconf@gnu.org." >&5
-echo "$as_me: WARNING: In the future, Autoconf will not detect cross-tools
-whose name does not start with the host triplet.  If you think this
-configuration is useful to you, please write to autoconf@gnu.org." >&2;}
-ac_tool_warned=yes ;;
-esac
-    OBJDUMP=$ac_ct_OBJDUMP
-  fi
-else
-  OBJDUMP="$ac_cv_prog_OBJDUMP"
-fi
-
-test -z "$OBJDUMP" && OBJDUMP=objdump
-
-
-
-
-
 
 { echo "$as_me:$LINENO: checking how to recognize dependent libraries" >&5
 echo $ECHO_N "checking how to recognize dependent libraries... $ECHO_C" >&6; }
@@ -7336,12 +7239,6 @@ mingw* | pw32*)
   fi
   ;;
 
-cegcc)
-  # use the weaker test based on 'objdump'. See mingw*.
-  lt_cv_deplibs_check_method='file_magic file format pe-arm-.*little(.*architecture: arm)?'
-  lt_cv_file_magic_cmd='$OBJDUMP -f'
-  ;;
-
 darwin* | rhapsody*)
   lt_cv_deplibs_check_method=pass_all
   ;;
@@ -7892,7 +7789,7 @@ case $host_os in
 aix*)
   symcode='[BCDT]'
   ;;
-cygwin* | mingw* | pw32* | cegcc*)
+cygwin* | mingw* | pw32*)
   symcode='[ABCDGISTW]'
   ;;
 hpux*)
@@ -8151,7 +8048,7 @@ ia64-*-hpux*)
   ;;
 *-*-irix6*)
   # Find out which ABI we are using.
-  echo '#line 8154 "configure"' > conftest.$ac_ext
+  echo '#line 8051 "configure"' > conftest.$ac_ext
   if { (eval echo "$as_me:$LINENO: \"$ac_compile\"") >&5
   (eval $ac_compile) 2>&5
   ac_status=$?
@@ -9563,11 +9460,11 @@ else
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:9566: $lt_compile\"" >&5)
+   (eval echo "\"\$as_me:9463: $lt_compile\"" >&5)
    (eval "$lt_compile" 2>conftest.err)
    ac_status=$?
    cat conftest.err >&5
-   echo "$as_me:9570: \$? = $ac_status" >&5
+   echo "$as_me:9467: \$? = $ac_status" >&5
    if (exit $ac_status) && test -s "$ac_outfile"; then
      # The compiler can only warn and ignore the option if not recognized
      # So say no if there are warnings other than the usual output.
@@ -9635,7 +9532,7 @@ echo $ECHO_N "checking for $compiler opt
       # PIC is the default for these OSes.
       ;;
 
-    mingw* | cygwin* | pw32* | os2* | cegcc*)
+    mingw* | cygwin* | pw32* | os2*)
       # This hack is so that the source file can tell whether it is being
       # built for inclusion in a dll (and should export symbols for example).
       # Although the cygwin gcc ignores -fPIC, still need this for old-style
@@ -9650,11 +9547,10 @@ echo $ECHO_N "checking for $compiler opt
       ;;
 
     hpux*)
-      # PIC is the default for 64-bit PA HP-UX, but not for 32-bit
-      # PA HP-UX.  On IA64 HP-UX, PIC is the default but the pic flag
-      # sets the default TLS model and affects inlining.
+      # PIC is the default for IA64 HP-UX and 64-bit HP-UX, but
+      # not for PA HP-UX.
       case $host_cpu in
-      hppa*64*)
+      hppa*64*|ia64*)
 	# +Z the default
 	;;
       *)
@@ -9704,7 +9600,7 @@ echo $ECHO_N "checking for $compiler opt
       fi
       ;;
 
-    mingw* | cygwin* | pw32* | os2* | cegcc*)
+    mingw* | cygwin* | pw32* | os2*)
       # This hack is so that the source file can tell whether it is being
       # built for inclusion in a dll (and should export symbols for example).
       lt_prog_compiler_pic='-DDLL_EXPORT'
@@ -9734,25 +9630,11 @@ echo $ECHO_N "checking for $compiler opt
 
     linux* | k*bsd*-gnu)
       case $cc_basename in
-      # old Intel for x86_64 which still supported -KPIC.
-      ecc*)
+      icc* | ecc* | ifort*)
 	lt_prog_compiler_wl='-Wl,'
 	lt_prog_compiler_pic='-KPIC'
 	lt_prog_compiler_static='-static'
         ;;
-      # icc used to be incompatible with GCC.
-      # ICC 10 doesn't accept -KPIC any more.
-      icc* | ifort*)
-	lt_prog_compiler_wl='-Wl,'
-	lt_prog_compiler_pic='-fPIC'
-	lt_prog_compiler_static='-static'
-        ;;
-      # Lahey Fortran 8.1.
-      lf95*)
-	lt_prog_compiler_wl='-Wl,'
-	lt_prog_compiler_pic='--shared'
-	lt_prog_compiler_static='--static'
-	;;
       pgcc* | pgf77* | pgf90* | pgf95*)
         # Portland Group compilers (*not* the Pentium gcc compiler,
 	# which looks to be a dead project)
@@ -9902,11 +9784,11 @@ else
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:9905: $lt_compile\"" >&5)
+   (eval echo "\"\$as_me:9787: $lt_compile\"" >&5)
    (eval "$lt_compile" 2>conftest.err)
    ac_status=$?
    cat conftest.err >&5
-   echo "$as_me:9909: \$? = $ac_status" >&5
+   echo "$as_me:9791: \$? = $ac_status" >&5
    if (exit $ac_status) && test -s "$ac_outfile"; then
      # The compiler can only warn and ignore the option if not recognized
      # So say no if there are warnings other than the usual output.
@@ -10007,11 +9889,11 @@ else
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:10010: $lt_compile\"" >&5)
+   (eval echo "\"\$as_me:9892: $lt_compile\"" >&5)
    (eval "$lt_compile" 2>out/conftest.err)
    ac_status=$?
    cat out/conftest.err >&5
-   echo "$as_me:10014: \$? = $ac_status" >&5
+   echo "$as_me:9896: \$? = $ac_status" >&5
    if (exit $ac_status) && test -s out/conftest2.$ac_objext
    then
      # The compiler can only warn and ignore the option if not recognized
@@ -10062,11 +9944,11 @@ else
    -e 's:.*FLAGS}\{0,1\} :&$lt_compiler_flag :; t' \
    -e 's: [^ ]*conftest\.: $lt_compiler_flag&:; t' \
    -e 's:$: $lt_compiler_flag:'`
-   (eval echo "\"\$as_me:10065: $lt_compile\"" >&5)
+   (eval echo "\"\$as_me:9947: $lt_compile\"" >&5)
    (eval "$lt_compile" 2>out/conftest.err)
    ac_status=$?
    cat out/conftest.err >&5
-   echo "$as_me:10069: \$? = $ac_status" >&5
+   echo "$as_me:9951: \$? = $ac_status" >&5
    if (exit $ac_status) && test -s out/conftest2.$ac_objext
    then
      # The compiler can only warn and ignore the option if not recognized
@@ -10166,7 +10048,7 @@ echo $ECHO_N "checking whether the $comp
   extract_expsyms_cmds=
 
   case $host_os in
-  cygwin* | mingw* | pw32* | cegcc*)
+  cygwin* | mingw* | pw32*)
     # FIXME: the MSVC++ port hasn't been tested in a loooong time
     # When not using gcc, we currently assume that we are using
     # Microsoft Visual C++.
@@ -10253,7 +10135,7 @@ _LT_EOF
       fi
       ;;
 
-    cygwin* | mingw* | pw32* | cegcc*)
+    cygwin* | mingw* | pw32*)
       # _LT_TAGVAR(hardcode_libdir_flag_spec, ) is actually meaningless,
       # as there is no search path for DLLs.
       hardcode_libdir_flag_spec='-L$libdir'
@@ -10319,9 +10201,6 @@ _LT_EOF
 	  tmp_addflag=' -i_dynamic -nofor_main' ;;
 	ifc* | ifort*)			# Intel Fortran compiler
 	  tmp_addflag=' -nofor_main' ;;
-	lf95*)				# Lahey Fortran 8.1
-	  whole_archive_flag_spec=
-	  tmp_sharedflag='--shared' ;;
 	xl[cC]*)			# IBM XL C 8.0 on PPC (deal with xlf below)
 	  tmp_sharedflag='-qmkshrobj'
 	  tmp_addflag= ;;
@@ -10554,7 +10433,6 @@ _LT_EOF
 	fi
       fi
 
-      export_dynamic_flag_spec='${wl}-bexpall'
       # It seems that -bexpall does not export symbols beginning with
       # underscore (_), so it is better to generate a list of symbols to export.
       always_export_symbols=yes
@@ -10721,7 +10599,7 @@ if test -z "$aix_libpath"; then aix_libp
       export_dynamic_flag_spec=-rdynamic
       ;;
 
-    cygwin* | mingw* | pw32* | cegcc*)
+    cygwin* | mingw* | pw32*)
       # When not using gcc, we currently assume that we are using
       # Microsoft Visual C++.
       # hardcode_libdir_flag_spec is actually meaningless, as there is
@@ -10752,11 +10630,7 @@ if test -z "$aix_libpath"; then aix_libp
   whole_archive_flag_spec=''
   link_all_deplibs=yes
   allow_undefined_flag="$_lt_dar_allow_undefined"
-  case $cc_basename in
-     ifort*) _lt_dar_can_shared=yes ;;
-     *) _lt_dar_can_shared=$GCC ;;
-  esac
-  if test "$_lt_dar_can_shared" = "yes"; then
+  if test "$GCC" = "yes"; then
     output_verbose_link_cmd=echo
     archive_cmds="\$CC -dynamiclib \$allow_undefined_flag -o \$lib \$libobjs \$deplibs \$compiler_flags -install_name \$rpath/\$soname \$verstring $_lt_dar_single_mod${_lt_dsymutil}"
     module_cmds="\$CC \$allow_undefined_flag -o \$lib -bundle \$libobjs \$deplibs \$compiler_flags${_lt_dsymutil}"
@@ -10848,7 +10722,7 @@ if test -z "$aix_libpath"; then aix_libp
 	  archive_cmds='$CC -shared ${wl}+h ${wl}$soname -o $lib $libobjs $deplibs $compiler_flags'
 	  ;;
 	ia64*)
-	  archive_cmds='$CC -shared -fPIC ${wl}+h ${wl}$soname ${wl}+nodefaultrpath -o $lib $libobjs $deplibs $compiler_flags'
+	  archive_cmds='$CC -shared ${wl}+h ${wl}$soname ${wl}+nodefaultrpath -o $lib $libobjs $deplibs $compiler_flags'
 	  ;;
 	*)
 	  archive_cmds='$CC -shared -fPIC ${wl}+h ${wl}$soname ${wl}+b ${wl}$install_libdir -o $lib $libobjs $deplibs $compiler_flags'
@@ -11586,14 +11460,14 @@ bsdi[45]*)
   # libtool to hard-code these into programs
   ;;
 
-cygwin* | mingw* | pw32* | cegcc*)
+cygwin* | mingw* | pw32*)
   version_type=windows
   shrext_cmds=".dll"
   need_version=no
   need_lib_prefix=no
 
   case $GCC,$host_os in
-  yes,cygwin* | yes,mingw* | yes,pw32* | yes,cegcc*)
+  yes,cygwin* | yes,mingw* | yes,pw32*)
     library_names_spec='$libname.dll.a'
     # DLL is installed to $(libdir)/../bin by postinstall_cmds
     postinstall_cmds='base_file=`basename \${file}`~
@@ -11616,7 +11490,7 @@ cygwin* | mingw* | pw32* | cegcc*)
       soname_spec='`echo ${libname} | sed -e 's/^lib/cyg/'``echo ${release} | $SED -e 's/[.]/-/g'`${versuffix}${shared_ext}'
       sys_lib_search_path_spec="/usr/lib /lib/w32api /lib /usr/local/lib"
       ;;
-    mingw* | cegcc*)
+    mingw*)
       # MinGW DLLs use traditional 'lib' prefix
       soname_spec='${libname}`echo ${release} | $SED -e 's/[.]/-/g'`${versuffix}${shared_ext}'
       sys_lib_search_path_spec=`$CC -print-search-dirs | $GREP "^libraries:" | $SED -e "s/^libraries://" -e "s,=/,/,g"`
@@ -12097,7 +11971,7 @@ tpf*)
   version_type=linux
   need_lib_prefix=no
   need_version=no
-  library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
+  library_name_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
   shlibpath_var=LD_LIBRARY_PATH
   shlibpath_overrides_runpath=no
   hardcode_into_libs=yes
@@ -12274,7 +12148,7 @@ else
     lt_cv_dlopen_self=yes
     ;;
 
-  mingw* | pw32* | cegcc*)
+  mingw* | pw32*)
     lt_cv_dlopen="LoadLibrary"
     lt_cv_dlopen_libs=
     ;;
@@ -12831,7 +12705,7 @@ else
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 12834 "configure"
+#line 12708 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -12872,6 +12746,10 @@ else
 #  endif
 #endif
 
+#ifdef __cplusplus
+extern "C" void exit (int);
+#endif
+
 void fnord() { int i=42;}
 int main ()
 {
@@ -12887,7 +12765,7 @@ int main ()
   else
     puts (dlerror ());
 
-  return status;
+    exit (status);
 }
 _LT_EOF
   if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
@@ -12927,7 +12805,7 @@ else
   lt_dlunknown=0; lt_dlno_uscore=1; lt_dlneed_uscore=2
   lt_status=$lt_dlunknown
   cat > conftest.$ac_ext <<_LT_EOF
-#line 12930 "configure"
+#line 12808 "configure"
 #include "confdefs.h"
 
 #if HAVE_DLFCN_H
@@ -12968,6 +12846,10 @@ else
 #  endif
 #endif
 
+#ifdef __cplusplus
+extern "C" void exit (int);
+#endif
+
 void fnord() { int i=42;}
 int main ()
 {
@@ -12983,7 +12865,7 @@ int main ()
   else
     puts (dlerror ());
 
-  return status;
+    exit (status);
 }
 _LT_EOF
   if { (eval echo "$as_me:$LINENO: \"$ac_link\"") >&5
@@ -19311,6 +19193,109 @@ fi
 
 
 
+# Check whether --enable-libmediaclient was given.
+if test "${enable_libmediaclient+set}" = set; then
+  enableval=$enable_libmediaclient;
+fi
+
+
+if test "x$enable_libmediaclient" = xyes; then
+    if test "x$LIBMEDIACLIENT_PREFIX" = x; then
+        LIBMEDIACLIENT_LIBS="-lmediaclient"
+    else
+        LIBMEDIACLIENT_CFLAGS="-I$LIBMEDIACLIENT_PREFIX"
+        LIBMEDIACLIENT_LIBS="-L$LIBMEDIACLIENT_PREFIX -lmediaclient"
+    fi
+
+    LIBS="$LIBS $LIBMEDIACLIENT_LIBS"
+    { echo "$as_me:$LINENO: checking for net_ioctl in -lmediaclient" >&5
+echo $ECHO_N "checking for net_ioctl in -lmediaclient... $ECHO_C" >&6; }
+if test "${ac_cv_lib_mediaclient_net_ioctl+set}" = set; then
+  echo $ECHO_N "(cached) $ECHO_C" >&6
+else
+  ac_check_lib_save_LIBS=$LIBS
+LIBS="-lmediaclient  $LIBS"
+cat >conftest.$ac_ext <<_ACEOF
+/* confdefs.h.  */
+_ACEOF
+cat confdefs.h >>conftest.$ac_ext
+cat >>conftest.$ac_ext <<_ACEOF
+/* end confdefs.h.  */
+
+/* Override any GCC internal prototype to avoid an error.
+   Use char because int might match the return type of a GCC
+   builtin and then its argument prototype would still apply.  */
+#ifdef __cplusplus
+extern "C"
+#endif
+char net_ioctl ();
+int
+main ()
+{
+return net_ioctl ();
+  ;
+  return 0;
+}
+_ACEOF
+rm -f conftest.$ac_objext conftest$ac_exeext
+if { (ac_try="$ac_link"
+case "(($ac_try" in
+  *\"* | *\`* | *\\*) ac_try_echo=\$ac_try;;
+  *) ac_try_echo=$ac_try;;
+esac
+eval "echo \"\$as_me:$LINENO: $ac_try_echo\"") >&5
+  (eval "$ac_link") 2>conftest.er1
+  ac_status=$?
+  grep -v '^ *+' conftest.er1 >conftest.err
+  rm -f conftest.er1
+  cat conftest.err >&5
+  echo "$as_me:$LINENO: \$? = $ac_status" >&5
+  (exit $ac_status); } && {
+	 test -z "$ac_c_werror_flag" ||
+	 test ! -s conftest.err
+       } && test -s conftest$ac_exeext &&
+       $as_test_x conftest$ac_exeext; then
+  ac_cv_lib_mediaclient_net_ioctl=yes
+else
+  echo "$as_me: failed program was:" >&5
+sed 's/^/| /' conftest.$ac_ext >&5
+
+	ac_cv_lib_mediaclient_net_ioctl=no
+fi
+
+rm -f core conftest.err conftest.$ac_objext conftest_ipa8_conftest.oo \
+      conftest$ac_exeext conftest.$ac_ext
+LIBS=$ac_check_lib_save_LIBS
+fi
+{ echo "$as_me:$LINENO: result: $ac_cv_lib_mediaclient_net_ioctl" >&5
+echo "${ECHO_T}$ac_cv_lib_mediaclient_net_ioctl" >&6; }
+if test $ac_cv_lib_mediaclient_net_ioctl = yes; then
+
+
+cat >>confdefs.h <<\_ACEOF
+#define HAVE_LIBMEDIACLIENT 1
+_ACEOF
+
+          ac_have_libmediaclient=yes
+
+else
+  LIBMEDIACLIENT_LIBS=""
+fi
+
+    LIBS="$ac_save_LIBS"
+fi
+ if test "x$ac_have_libmediaclient" = "xyes"; then
+  HAVE_LIBMEDIACLIENT_TRUE=
+  HAVE_LIBMEDIACLIENT_FALSE='#'
+else
+  HAVE_LIBMEDIACLIENT_TRUE='#'
+  HAVE_LIBMEDIACLIENT_FALSE=
+fi
+
+
+
+
+
 if test "x$with_x" != "xno"; then
    { echo "$as_me:$LINENO: checking for X" >&5
 echo $ECHO_N "checking for X... $ECHO_C" >&6; }
@@ -43401,6 +43386,13 @@ echo "$as_me: error: conditional \"HAVE_
 Usually this means the macro was only invoked conditionally." >&2;}
    { (exit 1); exit 1; }; }
 fi
+if test -z "${HAVE_LIBMEDIACLIENT_TRUE}" && test -z "${HAVE_LIBMEDIACLIENT_FALSE}"; then
+  { { echo "$as_me:$LINENO: error: conditional \"HAVE_LIBMEDIACLIENT\" was never defined.
+Usually this means the macro was only invoked conditionally." >&5
+echo "$as_me: error: conditional \"HAVE_LIBMEDIACLIENT\" was never defined.
+Usually this means the macro was only invoked conditionally." >&2;}
+   { (exit 1); exit 1; }; }
+fi
 if test -z "${HAVE_X11_TRUE}" && test -z "${HAVE_X11_FALSE}"; then
   { { echo "$as_me:$LINENO: error: conditional \"HAVE_X11\" was never defined.
 Usually this means the macro was only invoked conditionally." >&5
@@ -45054,6 +45046,10 @@ HAVE_MLIB_TRUE!$HAVE_MLIB_TRUE$ac_delim
 HAVE_MLIB_FALSE!$HAVE_MLIB_FALSE$ac_delim
 MLIB_LIBS!$MLIB_LIBS$ac_delim
 MLIB_CFLAGS!$MLIB_CFLAGS$ac_delim
+HAVE_LIBMEDIACLIENT_TRUE!$HAVE_LIBMEDIACLIENT_TRUE$ac_delim
+HAVE_LIBMEDIACLIENT_FALSE!$HAVE_LIBMEDIACLIENT_FALSE$ac_delim
+LIBMEDIACLIENT_CFLAGS!$LIBMEDIACLIENT_CFLAGS$ac_delim
+LIBMEDIACLIENT_LIBS!$LIBMEDIACLIENT_LIBS$ac_delim
 X_CFLAGS!$X_CFLAGS$ac_delim
 X_LIBS!$X_LIBS$ac_delim
 XMKMF!$XMKMF$ac_delim
@@ -45070,10 +45066,6 @@ OPENGL_LIBS!$OPENGL_LIBS$ac_delim
 GLU_LIBS!$GLU_LIBS$ac_delim
 HAVE_OPENGL_TRUE!$HAVE_OPENGL_TRUE$ac_delim
 HAVE_OPENGL_FALSE!$HAVE_OPENGL_FALSE$ac_delim
-HAVE_SYNCFB_TRUE!$HAVE_SYNCFB_TRUE$ac_delim
-HAVE_SYNCFB_FALSE!$HAVE_SYNCFB_FALSE$ac_delim
-HAVE_V4L_TRUE!$HAVE_V4L_TRUE$ac_delim
-HAVE_V4L_FALSE!$HAVE_V4L_FALSE$ac_delim
 _ACEOF
 
   if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 97; then
@@ -45115,6 +45107,10 @@ _ACEOF
 ac_delim='%!_!# '
 for ac_last_try in false false false false false :; do
   cat >conf$$subs.sed <<_ACEOF
+HAVE_SYNCFB_TRUE!$HAVE_SYNCFB_TRUE$ac_delim
+HAVE_SYNCFB_FALSE!$HAVE_SYNCFB_FALSE$ac_delim
+HAVE_V4L_TRUE!$HAVE_V4L_TRUE$ac_delim
+HAVE_V4L_FALSE!$HAVE_V4L_FALSE$ac_delim
 XV_CFLAGS!$XV_CFLAGS$ac_delim
 XV_LIBS!$XV_LIBS$ac_delim
 EXTRA_X_LIBS!$EXTRA_X_LIBS$ac_delim
@@ -45208,10 +45204,6 @@ MKNOD!$MKNOD$ac_delim
 DEPMOD!$DEPMOD$ac_delim
 VORBIS_CFLAGS!$VORBIS_CFLAGS$ac_delim
 VORBIS_LIBS!$VORBIS_LIBS$ac_delim
-HAVE_VORBIS_TRUE!$HAVE_VORBIS_TRUE$ac_delim
-HAVE_VORBIS_FALSE!$HAVE_VORBIS_FALSE$ac_delim
-THEORA_CFLAGS!$THEORA_CFLAGS$ac_delim
-THEORA_LIBS!$THEORA_LIBS$ac_delim
 _ACEOF
 
   if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 97; then
@@ -45253,6 +45245,10 @@ _ACEOF
 ac_delim='%!_!# '
 for ac_last_try in false false false false false :; do
   cat >conf$$subs.sed <<_ACEOF
+HAVE_VORBIS_TRUE!$HAVE_VORBIS_TRUE$ac_delim
+HAVE_VORBIS_FALSE!$HAVE_VORBIS_FALSE$ac_delim
+THEORA_CFLAGS!$THEORA_CFLAGS$ac_delim
+THEORA_LIBS!$THEORA_LIBS$ac_delim
 HAVE_THEORA_TRUE!$HAVE_THEORA_TRUE$ac_delim
 HAVE_THEORA_FALSE!$HAVE_THEORA_FALSE$ac_delim
 SPEEX_CFLAGS!$SPEEX_CFLAGS$ac_delim
@@ -45346,10 +45342,6 @@ HAVE_BSDI_CDROM!$HAVE_BSDI_CDROM$ac_deli
 HAVE_DARWIN_CDROM!$HAVE_DARWIN_CDROM$ac_delim
 HAVE_FREEBSD_CDROM!$HAVE_FREEBSD_CDROM$ac_delim
 HAVE_LINUX_CDROM!$HAVE_LINUX_CDROM$ac_delim
-HAVE_SOLARIS_CDROM!$HAVE_SOLARIS_CDROM$ac_delim
-HAVE_WIN32_CDROM!$HAVE_WIN32_CDROM$ac_delim
-LIBVCD_SYSDEP!$LIBVCD_SYSDEP$ac_delim
-LIBISO9660_LIBS!$LIBISO9660_LIBS$ac_delim
 _ACEOF
 
   if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 97; then
@@ -45391,6 +45383,10 @@ _ACEOF
 ac_delim='%!_!# '
 for ac_last_try in false false false false false :; do
   cat >conf$$subs.sed <<_ACEOF
+HAVE_SOLARIS_CDROM!$HAVE_SOLARIS_CDROM$ac_delim
+HAVE_WIN32_CDROM!$HAVE_WIN32_CDROM$ac_delim
+LIBVCD_SYSDEP!$LIBVCD_SYSDEP$ac_delim
+LIBISO9660_LIBS!$LIBISO9660_LIBS$ac_delim
 LIBVCD_CFLAGS!$LIBVCD_CFLAGS$ac_delim
 LIBVCD_LIBS!$LIBVCD_LIBS$ac_delim
 HAVE_VCDNAV_TRUE!$HAVE_VCDNAV_TRUE$ac_delim
@@ -45476,7 +45472,7 @@ LDFLAGS_NOUNDEFINED!$LDFLAGS_NOUNDEFINED
 LTLIBOBJS!$LTLIBOBJS$ac_delim
 _ACEOF
 
-  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 83; then
+  if test `sed -n "s/.*$ac_delim\$/X/p" conf$$subs.sed | grep -c X` = 87; then
     break
   elif $ac_last_try; then
     { { echo "$as_me:$LINENO: error: could not make $CONFIG_STATUS" >&5
@@ -46851,6 +46847,11 @@ echo "   - stdin_fifo    - rtp"
 echo "   - http          - mms"
 echo "   - pnm           - rtsp"
 echo "   - dvb"
+if test "x$ac_have_libmediaclient" = "xyes"; then
+  echo "   - bldvb (with em28xx libmediaclient support)"
+else
+  echo "   - bldvb"
+fi
 if test "x$external_dvdnav" = "xyes"; then
   echo "   - dvd (external libs)"
 else
@@ -47259,3 +47260,4 @@ if test "x$no_x" = "xyes"; then
       ;;
   esac
 fi
+
diff -Nupr xine-lib-1.1.16.2-original/configure.ac xine-lib-1.1.16.2-modified/configure.ac
--- xine-lib-1.1.16.2-original/configure.ac	2009-02-10 19:32:37.000000000 +0100
+++ xine-lib-1.1.16.2-modified/configure.ac	2009-05-20 18:48:16.000000000 +0200
@@ -498,6 +498,34 @@ AC_SUBST(MLIB_LIBS)
 AC_SUBST(MLIB_CFLAGS)
 
 dnl ---------------------------------------------
+dnl libmediaclient support
+dnl ---------------------------------------------
+
+AC_ARG_ENABLE([libmediaclient],
+	AS_HELP_STRING([--enable-libmediaclient], [build em28xx libmediaclient support]))
+
+if test "x$enable_libmediaclient" = xyes; then
+    if test "x$LIBMEDIACLIENT_PREFIX" = x; then
+        LIBMEDIACLIENT_LIBS="-lmediaclient"
+    else
+        LIBMEDIACLIENT_CFLAGS="-I$LIBMEDIACLIENT_PREFIX"
+        LIBMEDIACLIENT_LIBS="-L$LIBMEDIACLIENT_PREFIX -lmediaclient"
+    fi
+
+    LIBS="$LIBS $LIBMEDIACLIENT_LIBS"
+    AC_CHECK_LIB(mediaclient, net_ioctl,
+        [
+          AC_DEFINE(HAVE_LIBMEDIACLIENT,1,[Define this if you have libmediaclient installed])
+          ac_have_libmediaclient=yes
+        ],
+        [LIBMEDIACLIENT_LIBS=""])
+    LIBS="$ac_save_LIBS"
+fi
+AM_CONDITIONAL(HAVE_LIBMEDIACLIENT, test "x$ac_have_libmediaclient" = "xyes")
+AC_SUBST(LIBMEDIACLIENT_CFLAGS)
+AC_SUBST(LIBMEDIACLIENT_LIBS)
+
+dnl ---------------------------------------------
 dnl Checks for X11
 dnl ---------------------------------------------
 
@@ -2811,6 +2839,11 @@ echo "   - stdin_fifo    - rtp"
 echo "   - http          - mms"
 echo "   - pnm           - rtsp"
 echo "   - dvb"
+if test "x$ac_have_libmediaclient" = "xyes"; then
+  echo "   - bldvb (with em28xx libmediaclient support)"
+else
+  echo "   - bldvb"
+fi
 if test "x$external_dvdnav" = "xyes"; then
   echo "   - dvd (external libs)"
 else
@@ -3237,3 +3270,4 @@ if test "x$no_x" = "xyes"; then
       ;;
   esac
 fi
+
diff -Nupr xine-lib-1.1.16.2-original/Makefile.in xine-lib-1.1.16.2-modified/Makefile.in
--- xine-lib-1.1.16.2-original/Makefile.in	2009-02-10 19:35:03.000000000 +0100
+++ xine-lib-1.1.16.2-modified/Makefile.in	2009-05-25 13:39:26.000000000 +0200
@@ -217,6 +217,8 @@ LIBINTL = @LIBINTL@
 LIBISO9660_LIBS = @LIBISO9660_LIBS@
 LIBMAD_CFLAGS = @LIBMAD_CFLAGS@
 LIBMAD_LIBS = @LIBMAD_LIBS@
+LIBMEDIACLIENT_CFLAGS = @LIBMEDIACLIENT_CFLAGS@
+LIBMEDIACLIENT_LIBS = @LIBMEDIACLIENT_LIBS@
 LIBMODPLUG_CFLAGS = @LIBMODPLUG_CFLAGS@
 LIBMODPLUG_LIBS = @LIBMODPLUG_LIBS@
 LIBMPEG2_CFLAGS = @LIBMPEG2_CFLAGS@
diff -Nupr xine-lib-1.1.16.2-original/src/input/input_bldvb.c xine-lib-1.1.16.2-modified/src/input/input_bldvb.c
--- xine-lib-1.1.16.2-original/src/input/input_bldvb.c	1970-01-01 01:00:00.000000000 +0100
+++ xine-lib-1.1.16.2-modified/src/input/input_bldvb.c	2009-05-25 11:44:03.000000000 +0200
@@ -0,0 +1,1292 @@
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+/* pthread.h must be included first so rest of the headers are imported
+   thread safely (on some systems). */
+#include <pthread.h>
+
+#include <assert.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#include <unistd.h>
+#include <fcntl.h>
+#include <string.h>
+#include <sys/socket.h>
+#include <errno.h>
+#include <sys/time.h>
+#include <sys/ioctl.h>
+#include <poll.h>
+#ifdef __sun
+#include <sys/ioccom.h>
+#endif
+#include <sys/poll.h>
+#include <time.h>
+#ifdef HAVE_DIRENT_H
+#include <dirent.h>
+#endif
+#include <ctype.h>
+
+#include <linux/dvb/dmx.h>
+
+#define LOG_MODULE "input_bldvb"
+#define LOG_VERBOSE
+
+#include "xine_internal.h"
+#include "xineutils.h"
+#include "input_plugin.h"
+#include "net_buf_ctrl.h"
+
+#define BUFSIZE 16384
+
+#define DVB_NOPID 0xffff
+
+/* define stream types */
+#define VIDFILTER 0
+#define AUDFILTER 1
+
+#define MAX_FILTERS 2
+
+#ifdef HAVE_LIBMEDIACLIENT
+#include <frontend.h>
+#include <mediacmds.h>
+
+int net_open(char *node, int flags);
+int net_ioctl(int fd, int cmd, void *data);
+int net_close(int fd);
+#else
+#define net_open	open
+#define net_close	close
+#define net_ioctl	ioctl
+#endif
+
+typedef struct {
+	int                           fd_frontend;
+	int                           fd_pidfilter[MAX_FILTERS];
+	struct dvb_frontend_info      feinfo;
+	int                           adapter_num;
+
+	char                          frontend_device[100];
+	char                          dvr_device[100];
+	char                          demux_device[100];
+
+	struct dmx_pes_filter_params  pesFilterParams[MAX_FILTERS];
+	xine_t                       *xine;
+} tuner_t;
+
+
+typedef struct {
+	char                           *name;
+	struct dvb_frontend_parameters  front_param;
+	int                             pid[MAX_FILTERS];
+	int                             sat_no;
+	int                             tone;
+	int                             pol;
+} channel_t;
+
+typedef struct {
+	input_class_t  input_class;
+	xine_t        *xine;
+	char          *mrls[2];
+} bldvb_input_class_t;
+
+typedef struct {
+	input_plugin_t      input_plugin;
+	bldvb_input_class_t  *class;
+	xine_stream_t      *stream;
+	char               *mrl;
+	off_t               curpos;
+	nbc_t              *nbc;
+	tuner_t            *tuner;
+	channel_t           channel;
+	int                 fd;
+	/* Is channel tuned in correctly, i.e., can we read program stream? */
+	int                 tuned_in;
+	pthread_mutex_t     channel_change_mutex;
+	xine_event_queue_t *event_queue;
+	/* scratch buffer for forward seeking */
+	char                seek_buf[BUFSIZE];
+	/* simple vcr-like functionality */
+	int                 record_fd;
+	int                 record_paused;
+	/* centre cutout zoom */
+	int                 zoom_ok;
+	/* number of timedout reads in plugin_read */
+	int                 read_failcount;
+} bldvb_input_plugin_t;
+
+
+/* stuff for faster parsing of channel strings */
+typedef struct {
+	char *name;
+	int   value;
+} Param;
+
+static const Param inversion_list [] = {
+	{ "INVERSION_OFF", INVERSION_OFF   },
+	{ "INVERSION_ON",  INVERSION_ON    },
+	{ "INVERSION_AUTO", INVERSION_AUTO },
+	{ NULL, 0 }
+};
+static const Param bw_list [] = {
+	{ "BANDWIDTH_6_MHZ", BANDWIDTH_6_MHZ },
+	{ "BANDWIDTH_7_MHZ", BANDWIDTH_7_MHZ },
+	{ "BANDWIDTH_8_MHZ", BANDWIDTH_8_MHZ },
+	{ "BANDWIDTH_AUTO",  BANDWIDTH_AUTO  },
+	{ NULL, 0 }
+};
+static const Param fec_list [] = {
+	{ "FEC_1_2",  FEC_1_2  },
+	{ "FEC_2_3",  FEC_2_3  },
+	{ "FEC_3_4",  FEC_3_4  },
+	{ "FEC_4_5",  FEC_4_5  },
+	{ "FEC_5_6",  FEC_5_6  },
+	{ "FEC_6_7",  FEC_6_7  },
+	{ "FEC_7_8",  FEC_7_8  },
+	{ "FEC_8_9",  FEC_8_9  },
+	{ "FEC_AUTO", FEC_AUTO },
+	{ "FEC_NONE", FEC_NONE },
+	{ NULL, 0 }
+};
+static const Param guard_list [] = {
+	{ "GUARD_INTERVAL_1_16", GUARD_INTERVAL_1_16 },
+	{ "GUARD_INTERVAL_1_32", GUARD_INTERVAL_1_32 },
+	{ "GUARD_INTERVAL_1_4",  GUARD_INTERVAL_1_4  },
+	{ "GUARD_INTERVAL_1_8",  GUARD_INTERVAL_1_8  },
+	{ "GUARD_INTERVAL_AUTO", GUARD_INTERVAL_AUTO },
+	{ NULL, 0 }
+};
+static const Param hierarchy_list [] = {
+	{ "HIERARCHY_1",    HIERARCHY_1    },
+	{ "HIERARCHY_2",    HIERARCHY_2    },
+	{ "HIERARCHY_4",    HIERARCHY_4    },
+	{ "HIERARCHY_NONE", HIERARCHY_NONE },
+	{ "HIERARCHY_AUTO", HIERARCHY_AUTO },
+	{ NULL, 0 }
+};
+static const Param atsc_list [] = {
+	{ "8VSB",    VSB_8    },
+	{ "QAM_256", QAM_256  },
+	{ "QAM_64",  QAM_64   },
+	{ "QAM",     QAM_AUTO },
+	{ NULL, 0 }
+};
+static const Param qam_list [] = {
+	{ "QPSK",     QPSK     },
+	{ "QAM_128",  QAM_128  },
+	{ "QAM_16",   QAM_16   },
+	{ "QAM_256",  QAM_256  },
+	{ "QAM_32",   QAM_32   },
+	{ "QAM_64",   QAM_64   },
+	{ "QAM_AUTO", QAM_AUTO },
+	{ NULL, 0 }
+};
+static const Param transmissionmode_list [] = {
+	{ "TRANSMISSION_MODE_2K",   TRANSMISSION_MODE_2K   },
+	{ "TRANSMISSION_MODE_8K",   TRANSMISSION_MODE_8K   },
+	{ "TRANSMISSION_MODE_AUTO", TRANSMISSION_MODE_AUTO },
+	{ NULL, 0 }
+};
+
+
+/* Utility Functions */
+
+static void debug_time(struct timeval *startTime, const char *name)
+{
+	struct timeval endTime;
+	double t;
+	gettimeofday(&endTime, NULL);
+
+	t = endTime.tv_sec - startTime->tv_sec + ((double)(endTime.tv_usec) / 1000000) - ((double)(startTime->tv_usec) / 1000000);
+	fprintf(stderr, "time in %s: %fs\n", name, t);
+	fflush(stderr);
+}
+
+
+
+static void print_error(const char *error)
+{
+	fprintf(stderr, "BLDVB ERROR: %s\n", error);
+}
+
+
+
+static int find_param(const Param *list, const char *name)
+{
+	while(list->name && strcmp(list->name, name)) {
+		list++;
+	}
+
+	return list->value;;
+}
+
+static void tuner_dispose(tuner_t * this)
+{
+	int i;
+
+	if(this->fd_frontend >= 0) {
+		net_close(this->fd_frontend);
+	}
+
+	/* close all pid filter filedescriptors */
+	for(i = 0; i < MAX_FILTERS; ++i) {
+		if(this->fd_pidfilter[i] >= 0) {
+			close(this->fd_pidfilter[i]);
+		}
+	}
+
+	if(this) {
+		free(this);
+	}
+}
+
+
+static tuner_t *XINE_MALLOC tuner_init(xine_t * xine, int adapter)
+{
+	tuner_t *this;
+	int i;
+#ifdef HAVE_LIBMEDIACLIENT
+	struct fe_device_mode dev_mode;
+#endif
+
+	this = calloc(1, sizeof(tuner_t));
+	_x_assert(this != NULL);
+
+	xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": tuner_init adapter=%d\n", adapter);
+	this->fd_frontend = -1;
+	memset(this->fd_pidfilter, 0, sizeof(this->fd_pidfilter));
+
+	this->xine = xine;
+	this->adapter_num = adapter;
+
+	snprintf(this->frontend_device, 100, "/dev/dvb/adapter%i/frontend0", this->adapter_num);
+	snprintf(this->demux_device, 100, "/dev/dvb/adapter%i/demux0", this->adapter_num);
+	snprintf(this->dvr_device, 100, "/dev/dvb/adapter%i/dvr0", this->adapter_num);
+
+	xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": opening FRONTEND DEVICE: %s\n", this->frontend_device);
+	if((this->fd_frontend = net_open(this->frontend_device, O_RDWR)) < 0) {
+#ifdef HAVE_LIBMEDIACLIENT
+		switch(this->fd_frontend) {
+			case -MEDIA_DEVICE_UNSUPPORTED:
+				xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": %s doesn't support the extended media API\n", this->frontend_device);
+				break;
+			case -MEDIA_DEVICE_INVALID:
+				xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": unable to open device node: %s\n", this->frontend_device);
+				break;
+			default:
+				xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": unable to open device node (fd:%d): %s\n", this->fd_frontend, this->frontend_device);
+		}
+#else
+		xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": FRONTEND DEVICE: %s\n", strerror(errno));
+#endif
+		tuner_dispose(this);
+		return NULL;
+	}
+
+#ifdef HAVE_LIBMEDIACLIENT
+	dev_mode.mode = FE_DVBT;
+	net_ioctl(this->fd_frontend, FE_SET_DEVICE_MODE, &dev_mode);
+#endif
+
+	xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": retrieving info from FRONTEND DEVICE: %s\n", this->frontend_device);
+	if((net_ioctl(this->fd_frontend, FE_GET_INFO, &this->feinfo)) < 0) {
+		xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": FE_GET_INFO: %s\n", strerror(errno));
+		tuner_dispose(this);
+		return NULL;
+	}
+	xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": using DVB Card: %s\n", this->feinfo.name);
+
+	for(i = 0; i < MAX_FILTERS; ++i) {
+		this->fd_pidfilter[i] = open(this->demux_device, O_RDWR);
+		if(this->fd_pidfilter[i] < 0) {
+			xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": DEMUX DEVICE PIDfilter: %s\n", strerror(errno));
+			tuner_dispose(this);
+			return NULL;
+		}
+	}
+
+#ifndef HAVE_LIBMEDIACLIENT
+	fcntl(this->fd_frontend, F_SETFL, O_NONBLOCK);
+#endif
+
+	return this;
+}
+
+
+/**
+ * @return 1 on error, 0 otherwise
+ */
+static int bldvb_set_pidfilter(bldvb_input_plugin_t * this, int filter, ushort pid, int pidtype, int taptype)
+{
+	tuner_t *tuner = this->tuner;
+
+	if(this->channel.pid[filter] != DVB_NOPID) {
+		ioctl(tuner->fd_pidfilter[filter], DMX_STOP);
+	}
+
+	this->channel.pid[filter] = pid;
+	tuner->pesFilterParams[filter].pid = pid;
+	tuner->pesFilterParams[filter].input = DMX_IN_FRONTEND;
+	tuner->pesFilterParams[filter].output = taptype;
+	tuner->pesFilterParams[filter].pes_type = pidtype;
+	tuner->pesFilterParams[filter].flags = DMX_IMMEDIATE_START;
+	if(ioctl(tuner->fd_pidfilter[filter], DMX_SET_PES_FILTER, &tuner->pesFilterParams[filter]) < 0) {
+		xprintf(tuner->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": set_pid: %s\n", strerror(errno));
+		return 1;
+	}
+
+	return 0;
+}
+
+
+
+/**
+ * @param bldvb_input_plugin_t * - this
+ * @param char *str
+ *
+ * @return 1 on error, 0 otherwise
+ */
+static int bldvb_extract_channel_from_string(bldvb_input_plugin_t *this, char *str)
+{
+	/*
+		try to extract channel data from a string in the following format
+		(DVBS) QPSK: <channel name>:<frequency>:<polarisation>:<sat_no>:<sym_rate>:<vpid>:<apid>
+		(DVBC) QAM: <channel name>:<frequency>:<inversion>:<sym_rate>:<fec>:<qam>:<vpid>:<apid>
+		(DVBT) OFDM: <channel name>:<frequency>:<inversion>:
+						<bw>:<fec_hp>:<fec_lp>:<qam>:
+						<transmissionm>:<guardlist>:<hierarchinfo>:<vpid>:<apid>
+		(DVBA) ATSC: <channel name>:<frequency>:<qam>:<vpid>:<apid>
+
+		<channel name> = any string not containing ':'
+		<frequency>    = unsigned long
+		<polarisation> = 'v' or 'h'
+		<sat_no>       = unsigned long, usually 0 :D
+		<sym_rate>     = symbol rate in MSyms/sec
+
+
+		<inversion>    = INVERSION_ON | INVERSION_OFF | INVERSION_AUTO
+		<fec>          = FEC_1_2, FEC_2_3, FEC_3_4 .... FEC_AUTO ... FEC_NONE
+		<qam>          = QPSK, QAM_128, QAM_16, ATSC ...
+
+		<bw>           = BANDWIDTH_6_MHZ, BANDWIDTH_7_MHZ, BANDWIDTH_8_MHZ
+		<fec_hp>       = <fec>
+		<fec_lp>       = <fec>
+		<transmissionm> = TRANSMISSION_MODE_2K, TRANSMISSION_MODE_8K
+		<vpid>         = video program id
+		<apid>         = audio program id
+
+	*/
+	unsigned long freq;
+	char *field;
+	char *tmp;
+
+	tmp = str;
+
+	/* find the channel name */
+	if(!(field = strsep(&tmp,":"))) {
+		return 1;
+	}
+
+	if(this->channel.name) {
+		free(this->channel.name);
+	}
+	this->channel.name = strdup(field);
+
+	/* find the frequency */
+	if(!(field = strsep(&tmp, ":"))) {
+		return 1;
+	}
+	freq = strtoul(field, NULL, 0);
+
+	switch(this->tuner->feinfo.type)
+	{
+		case FE_QPSK:
+			if(freq > 11700) {
+				this->channel.front_param.frequency = (freq - 10600)*1000;
+				this->channel.tone = 1;
+			} else {
+				this->channel.front_param.frequency = (freq - 9750)*1000;
+				this->channel.tone = 0;
+			}
+			this->channel.front_param.inversion = INVERSION_AUTO;
+
+			/* find out the polarisation */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.pol = (field[0] == 'h' ? 0 : 1);
+
+			/* satellite number */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.sat_no = strtoul(field, NULL, 0);
+
+			/* symbol rate */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.qpsk.symbol_rate = strtoul(field, NULL, 0) * 1000;
+
+			this->channel.front_param.u.qpsk.fec_inner = FEC_AUTO;
+		break;
+		case FE_QAM:
+			this->channel.front_param.frequency = freq;
+
+			/* find out the inversion */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+
+			this->channel.front_param.inversion = find_param(inversion_list, field);
+
+			/* find out the symbol rate */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.qam.symbol_rate = strtoul(field, NULL, 0);
+
+			/* find out the fec */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.qam.fec_inner = find_param(fec_list, field);
+
+			/* find out the qam */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.qam.modulation = find_param(qam_list, field);
+		break;
+		case FE_OFDM:
+			/* DVB-T frequency is in kHz - workaround broken channels.confs */
+			if(freq < 1000000) {
+				freq*=1000;
+			}
+			this->channel.front_param.frequency = freq;
+
+			/* find out the inversion */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.inversion = find_param(inversion_list, field);
+
+			/* find out the bandwidth */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.ofdm.bandwidth = find_param(bw_list, field);
+
+			/* find out the fec_hp */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.ofdm.code_rate_HP = find_param(fec_list, field);
+
+			/* find out the fec_lp */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.ofdm.code_rate_LP = find_param(fec_list, field);
+
+			/* find out the qam */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.ofdm.constellation = find_param(qam_list, field);
+
+			/* find out the transmission mode */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.ofdm.transmission_mode = find_param(transmissionmode_list, field);
+
+			/* guard list */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.ofdm.guard_interval = find_param(guard_list, field);
+
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.ofdm.hierarchy_information = find_param(hierarchy_list, field);
+		break;
+		case FE_ATSC:
+			this->channel.front_param.frequency = freq;
+
+			/* find out the qam */
+			if(!(field = strsep(&tmp, ":"))) {
+				return 1;
+			}
+			this->channel.front_param.u.vsb.modulation = find_param(atsc_list, field);
+		break;
+	}
+
+	if(!(field = strsep(&tmp, ":"))) {
+		return 1;
+	}
+	this->channel.pid[VIDFILTER] = strtoul(field, NULL, 0);
+
+	if(!(field = strsep(&tmp, ":"))) {
+		return 1;
+	}
+	this->channel.pid[AUDFILTER] = strtoul(field, NULL, 0);
+
+	return 0;
+}
+
+
+
+
+
+
+static int tuner_set_diseqc(tuner_t *this, channel_t *c)
+{
+	struct dvb_diseqc_master_cmd cmd = {
+			{0xe0, 0x10, 0x38, 0xf0, 0x00, 0x00}, 4
+	};
+
+	cmd.msg[3] = 0xf0 | ((c->sat_no * 4) & 0x0f) | (c->tone ? 1 : 0) | (c->pol ? 0 : 2);
+
+	if(ioctl(this->fd_frontend, FE_SET_TONE, SEC_TONE_OFF) < 0) {
+		return 0;
+	}
+	if(ioctl(this->fd_frontend, FE_SET_VOLTAGE,
+			c->pol ? SEC_VOLTAGE_13 : SEC_VOLTAGE_18) < 0) {
+		return 0;
+	}
+	if(ioctl(this->fd_frontend, FE_DISEQC_SEND_MASTER_CMD, &cmd) < 0) {
+		return 0;
+	}
+	if(ioctl(this->fd_frontend, FE_DISEQC_SEND_BURST,
+			(c->sat_no / 4) % 2 ? SEC_MINI_B : SEC_MINI_A) < 0) {
+		return 0;
+	}
+	if(ioctl(this->fd_frontend, FE_SET_TONE,
+			c->tone ? SEC_TONE_ON : SEC_TONE_OFF) < 0) {
+		return 0;
+	}
+
+	return 1;
+}
+
+
+
+/**
+ * Tune to the requested freq. etc, wait for frontend to lock for a few seconds.
+ * if frontend can't lock, retire.
+ *
+ * @param tuner_t * - this
+ * @param struct dvb_frontend_parameters * -
+ *
+ *
+ */
+static int tuner_tune_it(
+		tuner_t *this,
+		struct dvb_frontend_parameters *front_param)
+{
+	fe_status_t status = 0;
+#ifndef HAVE_LIBMEDIACLIENT
+	unsigned int strength;
+#endif
+	xine_cfg_entry_t config_tuning_timeout;
+	struct timeval time_now;
+	struct timeval tuning_timeout;
+
+	if(net_ioctl(this->fd_frontend, FE_SET_FRONTEND, front_param) < 0) {
+		xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": setfront front: %s\n", strerror(errno));
+		return 0;
+	}
+	xprintf(this->xine, XINE_VERBOSITY_DEBUG, "after SET_FRONTEND(s)\n");
+
+	xine_config_lookup_entry(this->xine, "media.dvb.tuning_timeout", &config_tuning_timeout);
+	xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": media.dvb.tuning_timeout is %d\n", config_tuning_timeout.num_value );
+
+	if(config_tuning_timeout.num_value != 0 ) {
+		gettimeofday(&tuning_timeout, NULL );
+		if(config_tuning_timeout.num_value < 5) {
+			tuning_timeout.tv_sec += 5;
+		} else {
+			tuning_timeout.tv_sec += config_tuning_timeout.num_value;
+		}
+	}
+
+	xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": tuner_tune_it - waiting for lock...\n" );
+	do{
+		status = 0;
+		if(net_ioctl(this->fd_frontend, FE_READ_STATUS, &status) < 0) {
+			xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": fe get event: %s\n", strerror(errno));
+			return 0;
+		}
+
+		xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": status: %x\n", status);
+		if(status & FE_HAS_LOCK) {
+			break;
+		}
+
+		usleep(50000);
+
+		/* FE_TIMEDOUT does not happen in a no signal condition.
+		 * Use the tuning_timeout config to prevent a hang in this loop
+		 */
+		if(config_tuning_timeout.num_value != 0) {
+			gettimeofday( &time_now, NULL );
+			if(time_now.tv_sec > tuning_timeout.tv_sec) {
+				xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": No FE_HAS_LOCK before timeout\n");
+				break;
+			}
+		}
+
+		xprintf(this->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": Trying to get lock...");
+	} while(!(status & FE_TIMEDOUT));
+
+	/* inform the user of frontend status */
+	xprintf(this->xine,XINE_VERBOSITY_LOG, LOG_MODULE": Tuner status:  ");
+
+	if(status & FE_HAS_SIGNAL)
+		xprintf(this->xine,XINE_VERBOSITY_LOG," FE_HAS_SIGNAL");
+	if(status & FE_TIMEDOUT)
+		xprintf(this->xine,XINE_VERBOSITY_LOG," FE_TIMEDOUT");
+	if(status & FE_HAS_LOCK)
+		xprintf(this->xine,XINE_VERBOSITY_LOG," FE_HAS_LOCK");
+	if(status & FE_HAS_CARRIER)
+		xprintf(this->xine,XINE_VERBOSITY_LOG," FE_HAS_CARRIER");
+	if(status & FE_HAS_VITERBI)
+		xprintf(this->xine,XINE_VERBOSITY_LOG," FE_HAS_VITERBI");
+	if(status & FE_HAS_SYNC)
+		xprintf(this->xine,XINE_VERBOSITY_LOG," FE_HAS_SYNC");
+
+	xprintf(this->xine,XINE_VERBOSITY_LOG,"\n");
+
+#ifndef HAVE_LIBMEDIACLIENT
+	strength = 0;
+	if(net_ioctl(this->fd_frontend, FE_READ_BER, &strength) >= 0)
+		xprintf(this->xine,XINE_VERBOSITY_LOG, LOG_MODULE": Bit error rate: %i\n",strength);
+
+	strength = 0;
+	if(net_ioctl(this->fd_frontend, FE_READ_SIGNAL_STRENGTH, &strength) >= 0)
+		xprintf(this->xine,XINE_VERBOSITY_LOG, LOG_MODULE": Signal strength: %u\n",strength);
+
+	strength = 0;
+	if(net_ioctl(this->fd_frontend, FE_READ_SNR, &strength) >= 0)
+		xprintf(this->xine,XINE_VERBOSITY_LOG, LOG_MODULE": Signal/Noise Ratio: %u\n",strength);
+#endif
+
+	if (status & FE_HAS_LOCK && !(status & FE_TIMEDOUT)) {
+		xprintf(this->xine,XINE_VERBOSITY_LOG, LOG_MODULE": Lock achieved at %lu Hz\n",(unsigned long)front_param->frequency);
+		return 1;
+	} else {
+		xprintf(this->xine,XINE_VERBOSITY_LOG, LOG_MODULE": Unable to achieve lock at %lu Hz\n",(unsigned long)front_param->frequency);
+		return 0;
+	}
+}
+
+
+
+/*
+ * OK
+ */
+static int tuner_set_channel(bldvb_input_plugin_t *this, channel_t *c)
+{
+	tuner_t *tuner=this->tuner;
+
+	if(tuner->feinfo.type == FE_QPSK) {
+		if(!(tuner->feinfo.caps & FE_CAN_INVERSION_AUTO)) {
+			c->front_param.inversion = INVERSION_OFF;
+		}
+		if(!tuner_set_diseqc(tuner, c)) {
+			return 0;
+		}
+	}
+
+	if(!tuner_tune_it(tuner, &c->front_param)) {
+		return 0;
+	}
+
+	return 1;
+}
+
+
+/**
+ * try to switch to a channel (set up tuner and pids)
+ *
+ * @param bldvb_input_plugin_t * - this
+ * @param char * - channel string, containing required fields for this tuner type, separeted by colons
+ *
+ * @return 0 on error, 1 otherwise
+ */
+static int bldvb_switch_channel(bldvb_input_plugin_t *this, char *channel)
+{
+	struct timeval tv;
+	gettimeofday(&tv, NULL);
+
+
+	int i;
+	xine_event_t     event;
+	xine_pids_data_t data;
+
+	if(bldvb_extract_channel_from_string(this, channel)) {
+		print_error(channel);
+		return 0;
+	}
+
+	xprintf(this->class->xine, XINE_VERBOSITY_LOG, LOG_MODULE": switching to %s\n", channel);
+
+	/* control_nop appears to stop an occasional (quite long) pause between
+	   channel-changes, which the user may see as a lockup. */
+	_x_demux_control_nop(this->stream, BUF_FLAG_END_STREAM);
+	_x_demux_flush_engine(this->stream);
+
+	pthread_mutex_lock(&this->channel_change_mutex);
+
+	close(this->fd);
+	this->tuned_in = 0;
+
+	for(i = 0; i < MAX_FILTERS; ++i) {
+		close(this->tuner->fd_pidfilter[i]);
+		this->tuner->fd_pidfilter[i] = open(this->tuner->demux_device, O_RDWR);
+	}
+
+	if(!tuner_set_channel(this, &this->channel)) {
+		xprintf(this->class->xine, XINE_VERBOSITY_LOG,
+				_(LOG_MODULE": tuner_set_channel failed\n"));
+		pthread_mutex_unlock(&this->channel_change_mutex);
+		return 0;
+	}
+
+	event.type = XINE_EVENT_PIDS_CHANGE;
+	data.vpid = this->channel.pid[VIDFILTER];
+	data.apid = this->channel.pid[AUDFILTER];
+	event.data = &data;
+	event.data_length = sizeof(xine_pids_data_t);
+	xine_event_send(this->stream, &event);
+
+	this->fd = open(this->tuner->dvr_device, O_RDONLY | O_NONBLOCK);
+	this->tuned_in = 1;
+
+	pthread_mutex_unlock (&this->channel_change_mutex);
+
+	if(bldvb_set_pidfilter(this, VIDFILTER, this->channel.pid[VIDFILTER], DMX_PES_OTHER, DMX_OUT_TS_TAP)) {
+		print_error("can't set video pid");
+	}
+	if(bldvb_set_pidfilter(this, AUDFILTER, this->channel.pid[AUDFILTER], DMX_PES_OTHER, DMX_OUT_TS_TAP)) {
+		print_error("can't set audio pid");
+	}
+
+	//debug_time(&tv, "switch_channel");
+
+	return 1;
+}
+
+
+
+static void do_record(bldvb_input_plugin_t *this)
+{
+
+	struct tm *tma;
+	time_t *t;
+	char filename [256];
+	char dates[64];
+	xine_cfg_entry_t savedir;
+	DIR *dir;
+	int i = 0;
+
+	if(this->record_fd > -1) {
+		/* stop recording */
+		close(this->record_fd);
+		this->record_fd = -1;
+		this->record_paused=0;
+	} else {
+		t = calloc(1, sizeof(time_t));
+		_x_assert(t != NULL);
+		time(t);
+		tma = localtime(t);
+		free(t);
+		t = NULL;
+		strftime(dates, 63, "%Y-%m-%d_%H%M", tma);
+
+		if(xine_config_lookup_entry(this->stream->xine, "media.capture.save_dir", &savedir)) {
+			if(strlen(savedir.str_value) > 1) {
+				if((dir = opendir(savedir.str_value)) == NULL) {
+					snprintf(filename, 256, "%s/%s_%s.ts", xine_get_homedir(), this->channel.name, dates);
+					xprintf(this->class->xine,XINE_VERBOSITY_LOG,LOG_MODULE": savedir is wrong... saving to home directory\n");
+				} else {
+					closedir(dir);
+					snprintf(filename, 256, "%s/%s_%s.ts", savedir.str_value, this->channel.name, dates);
+					xprintf(this->class->xine,XINE_VERBOSITY_LOG,LOG_MODULE": saving to savedir\n");
+				}
+			} else {
+				snprintf(filename, 256, "%s/%s_%s.ts",xine_get_homedir(),this->channel.name, dates);
+				xprintf(this->class->xine,XINE_VERBOSITY_LOG,LOG_MODULE": Saving to HomeDir\n");
+			}
+		}
+		/* remove spaces from name */
+		while((filename[i] != 0) && i < 255) {
+			if(filename[i]==' ') {
+				filename[i]='_';
+			}
+			++i;
+		}
+		/* start recording */
+		this->record_fd = open(filename, O_CREAT | O_APPEND | O_WRONLY, 0644);
+	}
+}
+
+static void bldvb_event_handler(bldvb_input_plugin_t *this)
+{
+	xine_event_t *event;
+	char *chan;
+
+	while((event = xine_event_get (this->event_queue))) {
+		xprintf(this->class->xine, XINE_VERBOSITY_DEBUG, LOG_MODULE": got event %08x\n", event->type);
+		if(this->fd < 0) {
+			xine_event_free(event);
+			return;
+		}
+		switch (event->type) {
+			case XINE_EVENT_INPUT_SELECT:
+				chan = event->data;
+				bldvb_switch_channel(this, chan);
+				break;
+			case XINE_EVENT_INPUT_MENU2:
+				do_record(this);
+				break;
+			case XINE_EVENT_INPUT_MENU3:
+				/* zoom for cropped 4:3 in a 16:9 window */
+				if(!this->zoom_ok) {
+					this->zoom_ok = 1;
+					this->stream->video_out->set_property(
+							this->stream->video_out, VO_PROP_ZOOM_X, 133);
+					this->stream->video_out->set_property(
+							this->stream->video_out, VO_PROP_ZOOM_Y, 133);
+				} else {
+					this->zoom_ok = 0;
+					this->stream->video_out->set_property(
+							this->stream->video_out, VO_PROP_ZOOM_X, 100);
+					this->stream->video_out->set_property(
+							this->stream->video_out, VO_PROP_ZOOM_Y, 100);
+				}
+				break;
+			case XINE_EVENT_INPUT_MENU4:
+				/* Pause recording.. */
+				if((this->record_fd > -1) && (!this->record_paused)) {
+					this->record_paused = 1;
+				} else {
+					this->record_paused=0;
+				}
+				break;
+		}
+		xine_event_free (event);
+	}
+}
+
+static off_t bldvb_plugin_read(
+		input_plugin_t *this_gen,
+		char *buf,
+		off_t len)
+{
+	bldvb_input_plugin_t *this = (bldvb_input_plugin_t *)this_gen;
+	off_t n                  = 0;
+	off_t total              = 0;
+	int have_mutex           = 0;
+	struct pollfd pfd;
+
+	if(!this->tuned_in) {
+		return 0;
+	}
+
+	bldvb_event_handler(this);
+
+	/* protect against channel changes */
+	have_mutex =  pthread_mutex_lock(&this->channel_change_mutex);
+
+	while(total < len) {
+		pfd.fd      = this->fd;
+		pfd.events  = POLLPRI | POLLIN | POLLERR;
+		pfd.revents = 0;
+
+		if(!this->tuned_in) {
+			pthread_mutex_unlock(&this->channel_change_mutex );
+			return 0;
+		}
+
+		if(poll(&pfd, 1, 1500) < 1) {
+			this->read_failcount++;
+			break;
+		}
+
+		if(this->read_failcount) {
+			/* signal/stream regained after loss -
+			   kick the net_buf_control layer. */
+			this->read_failcount = 0;
+			_x_demux_control_start(this->stream);
+		}
+
+		if(pfd.revents & POLLPRI || pfd.revents & POLLIN) {
+			n = read (this->fd, &buf[total], len - total);
+		} else {
+			if(pfd.revents & POLLERR) {
+				_x_demux_control_end(this->stream, BUF_FLAG_END_USER);
+				this->read_failcount++;
+				break;
+			}
+		}
+
+		if(n > 0){
+			this->curpos += n;
+			total += n;
+		} else if(n < 0 && errno != EAGAIN) {
+			break;
+		}
+	}
+
+	if((this->record_fd) && (!this->record_paused)) {
+		if(write(this->record_fd, buf, total) == -1)
+			_x_message(this->stream,1,"Error while recording. Please check file.", NULL);
+	}
+
+	pthread_mutex_unlock( &this->channel_change_mutex );
+
+	/* no data for several seconds - tell the user a possible reason */
+	if(this->read_failcount == 5) {
+		_x_message(this->stream,1,"DVB Signal Lost. Please check connections.", NULL);
+	}
+
+	return total;
+}
+
+
+
+static buf_element_t *bldvb_plugin_read_block(
+		input_plugin_t *this_gen,
+		fifo_buffer_t *fifo,
+		off_t todo)
+{
+	buf_element_t *buf = fifo->buffer_pool_alloc(fifo);
+	int total_bytes;
+
+	if(todo > buf->max_size) {
+		todo = buf->max_size;
+	}
+
+	if(todo < 0) {
+		buf->free_buffer(buf);
+		return NULL;
+	}
+
+	buf->content = buf->mem;
+	buf->type    = BUF_DEMUX_BLOCK;
+
+	total_bytes = bldvb_plugin_read(this_gen, buf->content, todo);
+
+	if(total_bytes != todo) {
+		buf->free_buffer (buf);
+		return NULL;
+	}
+
+	buf->size = total_bytes;
+
+	return buf;
+}
+
+
+
+static off_t bldvb_plugin_seek(
+		input_plugin_t *this_gen,
+		off_t offset,
+		int origin)
+{
+	bldvb_input_plugin_t *this = (bldvb_input_plugin_t *)this_gen;
+
+	xprintf(this->class->xine,XINE_VERBOSITY_DEBUG,LOG_MODULE": seek %" PRIdMAX " bytes, origin %d\n", (intmax_t)offset, origin);
+
+	/* only relative forward-seeking is implemented */
+	if((origin == SEEK_CUR) && (offset >= 0)) {
+		for (;((int)offset) - BUFSIZE > 0; offset -= BUFSIZE) {
+			this->curpos += bldvb_plugin_read(this_gen, this->seek_buf, BUFSIZE);
+		}
+		this->curpos += bldvb_plugin_read(this_gen, this->seek_buf, offset);
+	}
+
+	return this->curpos;
+}
+
+
+
+static off_t bldvb_plugin_get_length(input_plugin_t *this_gen)
+{
+	return 0;
+}
+
+
+
+static uint32_t bldvb_plugin_get_capabilities(input_plugin_t *this_gen)
+{
+	return 0;
+}
+
+
+
+static uint32_t bldvb_plugin_get_blocksize(input_plugin_t *this_gen)
+{
+	return 0;
+}
+
+
+
+static off_t bldvb_plugin_get_current_pos(input_plugin_t *this_gen)
+{
+	bldvb_input_plugin_t *this = (bldvb_input_plugin_t *)this_gen;
+
+	return this->curpos;
+}
+
+
+
+static void bldvb_plugin_dispose(input_plugin_t *this_gen)
+{
+	bldvb_input_plugin_t *this = (bldvb_input_plugin_t *) this_gen;
+
+	if (this->fd != -1) {
+		close(this->fd);
+		this->fd = -1;
+	}
+
+	if(this->nbc) {
+		nbc_close(this->nbc);
+		this->nbc = NULL;
+	}
+
+	if(this->event_queue) {
+		xine_event_dispose_queue(this->event_queue);
+	}
+
+	if(this->mrl) {
+		free(this->mrl);
+	}
+
+	if(this->tuner) {
+		tuner_dispose(this->tuner);
+	}
+
+	if(this->channel.name) {
+		free(this->channel.name);
+	}
+
+	free(this);
+}
+
+
+
+static const char* bldvb_plugin_get_mrl (input_plugin_t *this_gen)
+{
+	bldvb_input_plugin_t *this = (bldvb_input_plugin_t *)this_gen;
+
+	return this->mrl;
+}
+
+
+
+static int bldvb_plugin_get_optional_data(
+		input_plugin_t *this_gen,
+		void *data,
+		int data_type)
+{
+	return INPUT_OPTIONAL_UNSUPPORTED;
+}
+
+
+
+/* allow center cutout zoom for dvb content */
+static void bldvb_plugin_zoom_cb(void *this_gen, xine_cfg_entry_t *cfg)
+{
+	bldvb_input_plugin_t *this = (bldvb_input_plugin_t *)this_gen;
+
+	if(!this) {
+		return;
+	}
+
+	this->zoom_ok = cfg->num_value;
+
+	if(this->zoom_ok) {
+		this->stream->video_out->set_property(this->stream->video_out, VO_PROP_ZOOM_X, 133);
+		this->stream->video_out->set_property(this->stream->video_out, VO_PROP_ZOOM_Y, 133);
+	} else {
+		this->stream->video_out->set_property(this->stream->video_out, VO_PROP_ZOOM_X, 100);
+		this->stream->video_out->set_property(this->stream->video_out, VO_PROP_ZOOM_Y, 100);
+	}
+}
+
+
+/**
+ * @return 0 on error, 1 otherwise
+ */
+static int bldvb_plugin_open(input_plugin_t * this_gen)
+{
+	bldvb_input_plugin_t *this = (bldvb_input_plugin_t *) this_gen;
+
+	tuner_t *tuner;
+	config_values_t *config = this->stream->xine->config;
+	char *ptr;
+	xine_cfg_entry_t zoomdvb;
+	xine_cfg_entry_t adapter;
+
+	/* get adapter number: /dev/dvb/adapter<i>/ */
+	xine_config_lookup_entry(this->stream->xine, "media.dvb.adapter", &adapter);
+
+	/* zoom for 4:3 in a 16:9 window */
+	config->register_bool(config, "media.dvb.zoom",
+			0,
+			_("use DVB 'center cutout' (zoom)"),
+			_("This will allow fullscreen "
+					"playback of 4:3 content "
+					"transmitted in a 16:9 frame."),
+			0, &bldvb_plugin_zoom_cb, (void *) this);
+	if(xine_config_lookup_entry(this->stream->xine, "media.dvb.zoom", &zoomdvb)) {
+		bldvb_plugin_zoom_cb((input_plugin_t *) this, &zoomdvb);
+	}
+
+	if(!(tuner = tuner_init(this->class->xine, adapter.num_value))) {
+		xprintf(this->class->xine, XINE_VERBOSITY_LOG, _(LOG_MODULE": cannot open dvb device\n"));
+		return 0;
+	}
+	this->tuner = tuner;
+
+	this->event_queue = xine_event_new_queue(this->stream);
+
+	pthread_mutex_init(&this->channel_change_mutex, NULL);
+
+
+	ptr = this->mrl;
+	ptr += 8;
+	bldvb_switch_channel(this, ptr);
+
+	return 1;
+}
+
+
+static input_plugin_t *bldvb_class_get_instance(
+		input_class_t *class_gen,
+		xine_stream_t *stream,
+		const char *data)
+{
+	bldvb_input_class_t  *class = (bldvb_input_class_t *)class_gen;
+	bldvb_input_plugin_t *this;
+	char               *mrl = (char *)data;
+
+	if(strncasecmp (mrl, "bldvb://", 8)) {
+		return NULL;
+	}
+
+	this = calloc(1, sizeof(bldvb_input_plugin_t));
+	_x_assert(this != NULL);
+
+	this->stream         = stream;
+	this->mrl            = strdup(mrl);
+	this->class          = class;
+	this->tuner          = NULL;
+	this->fd             = -1;
+	this->tuned_in       = 0;
+	this->nbc            = nbc_init(this->stream);
+	//this->nbc = NULL;
+	this->event_queue    = NULL;
+	this->record_fd      = -1;
+	this->read_failcount = 0;
+
+	this->input_plugin.open              = bldvb_plugin_open;
+	this->input_plugin.get_capabilities  = bldvb_plugin_get_capabilities;
+	this->input_plugin.read              = bldvb_plugin_read;
+	this->input_plugin.read_block        = bldvb_plugin_read_block;
+	this->input_plugin.seek              = bldvb_plugin_seek;
+	this->input_plugin.get_current_pos   = bldvb_plugin_get_current_pos;
+	this->input_plugin.get_length        = bldvb_plugin_get_length;
+	this->input_plugin.get_blocksize     = bldvb_plugin_get_blocksize;
+	this->input_plugin.get_mrl           = bldvb_plugin_get_mrl;
+	this->input_plugin.get_optional_data = bldvb_plugin_get_optional_data;
+	this->input_plugin.dispose           = bldvb_plugin_dispose;
+	this->input_plugin.input_class       = class_gen;
+
+	nbc_set_buffer_length(this->nbc, 300);
+
+	return &this->input_plugin;
+}
+
+
+
+/*
+ * dvb input plugin class stuff
+ */
+
+static const char *bldvb_class_get_description(input_class_t *this_gen)
+{
+	return _("BLDVB (Digital TV) input plugin");
+}
+
+
+
+static const char *bldvb_class_get_identifier(input_class_t *this_gen)
+{
+	return "bldvb";
+}
+
+
+
+static void bldvb_class_dispose(input_class_t * this_gen)
+{
+	bldvb_input_class_t *class = (bldvb_input_class_t *)this_gen;
+
+	free(class);
+}
+
+
+
+static void *init_class(xine_t *xine, void *data)
+{
+	bldvb_input_class_t  *this;
+	config_values_t *config = xine->config;
+
+	this = calloc(1, sizeof (bldvb_input_class_t));
+	_x_assert(this != NULL);
+
+	this->xine   = xine;
+
+	this->input_class.get_instance       = bldvb_class_get_instance;
+	this->input_class.get_identifier     = bldvb_class_get_identifier;
+	this->input_class.get_description    = bldvb_class_get_description;
+	this->input_class.dispose            = bldvb_class_dispose;
+	this->input_class.get_dir            = NULL;
+	this->input_class.get_autoplay_list  = NULL;
+	this->input_class.eject_media        = NULL;
+
+	this->mrls[0] = "bldvb://";
+	this->mrls[1] = 0;
+
+	xprintf(this->xine,XINE_VERBOSITY_DEBUG,"init class succeeded\n");
+
+	config->register_num(
+			config, "media.dvb.tuning_timeout", 0,
+			_("Number of seconds until tuning times out."),
+			_("Leave at 0 means try forever. "
+					"Greater than 0 means wait that many seconds to get a lock. Minimum is 5 seconds."),
+			0, NULL, (void *) this);
+
+	config->register_num(
+			config, "media.dvb.adapter", 0,
+			_("Number of dvb card to use."),
+			_("Leave this at zero unless you really have more than 1 card in your system."),
+			0, NULL, (void *) this);
+	return this;
+}
+
+
+/*
+ * exported plugin catalog entry
+ */
+const plugin_info_t xine_plugin_info[] EXPORTED = {
+		/* type, API, "name", version, special_info, init_function */
+		{ PLUGIN_INPUT | PLUGIN_MUST_PRELOAD, 17, "BLDVB", XINE_VERSION_CODE, NULL, init_class },
+		{ PLUGIN_NONE, 0, "", 0, NULL, NULL }
+};
diff -Nupr xine-lib-1.1.16.2-original/src/input/Makefile.am xine-lib-1.1.16.2-modified/src/input/Makefile.am
--- xine-lib-1.1.16.2-original/src/input/Makefile.am	2009-02-10 18:32:23.000000000 +0100
+++ xine-lib-1.1.16.2-modified/src/input/Makefile.am	2009-05-20 18:47:47.000000000 +0200
@@ -47,9 +47,10 @@ if WIN32
 else
 in_rtp = xineplug_inp_rtp.la
 in_dvb = xineplug_inp_dvb.la 
+in_bldvb = xineplug_inp_bldvb.la
 endif
 
-AM_CFLAGS = -D_LARGEFILE64_SOURCE $(GNOME_VFS_CFLAGS) $(ALSA_CFLAGS) $(DVD_CFLAGS)
+AM_CFLAGS = -D_LARGEFILE64_SOURCE $(GNOME_VFS_CFLAGS) $(ALSA_CFLAGS) $(DVD_CFLAGS) $(LIBMEDIACLIENT_CFLAGS)
 
 xineplug_LTLIBRARIES = \
 	xineplug_inp_file.la \
@@ -67,6 +68,7 @@ xineplug_LTLIBRARIES = \
 	xineplug_inp_net.la \
 	$(in_pvr) \
 	$(in_dvb) \
+	$(in_bldvb) \
 	xineplug_inp_cdda.la
 
 
@@ -120,6 +122,11 @@ xineplug_inp_dvb_la_LIBADD = $(XINE_LIB)
 xineplug_inp_dvb_la_CFLAGS = $(VISIBILITY_FLAG) $(AM_CFLAGS)
 xineplug_inp_dvb_la_LDFLAGS = -avoid-version -module
 
+xineplug_inp_bldvb_la_SOURCES = input_bldvb.c net_buf_ctrl.c
+xineplug_inp_bldvb_la_LIBADD = $(LIBMEDIACLIENT_LIBS) $(XINE_LIB) $(PTHREAD_LIBS) $(LTLIBINTL)
+xineplug_inp_bldvb_la_CFLAGS = $(VISIBILITY_FLAG) $(AM_CFLAGS)
+xineplug_inp_bldvb_la_LDFLAGS = -avoid-version -module
+
 xineplug_inp_rtsp_la_SOURCES = input_rtsp.c net_buf_ctrl.c
 xineplug_inp_rtsp_la_LIBADD = $(XINE_LIB) $(PTHREAD_LIBS) $(LTLIBINTL) libreal/libreal.la librtsp/librtsp.la
 xineplug_inp_rtsp_la_CFLAGS = $(VISIBILITY_FLAG) $(AM_CFLAGS)
diff -Nupr xine-lib-1.1.16.2-original/src/input/Makefile.in xine-lib-1.1.16.2-modified/src/input/Makefile.in
--- xine-lib-1.1.16.2-original/src/input/Makefile.in	2009-02-10 19:34:51.000000000 +0100
+++ xine-lib-1.1.16.2-modified/src/input/Makefile.in	2009-05-20 18:47:47.000000000 +0200
@@ -72,6 +72,17 @@ am__installdirs = "$(DESTDIR)$(xineplugd
 xineplugLTLIBRARIES_INSTALL = $(INSTALL)
 LTLIBRARIES = $(xineplug_LTLIBRARIES)
 am__DEPENDENCIES_1 =
+xineplug_inp_bldvb_la_DEPENDENCIES = $(am__DEPENDENCIES_1) $(XINE_LIB) \
+	$(am__DEPENDENCIES_1) $(am__DEPENDENCIES_1)
+am_xineplug_inp_bldvb_la_OBJECTS =  \
+	xineplug_inp_bldvb_la-input_bldvb.lo \
+	xineplug_inp_bldvb_la-net_buf_ctrl.lo
+xineplug_inp_bldvb_la_OBJECTS = $(am_xineplug_inp_bldvb_la_OBJECTS)
+xineplug_inp_bldvb_la_LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) \
+	$(LIBTOOLFLAGS) --mode=link $(CCLD) \
+	$(xineplug_inp_bldvb_la_CFLAGS) $(CFLAGS) \
+	$(xineplug_inp_bldvb_la_LDFLAGS) $(LDFLAGS) -o $@
+@WIN32_FALSE@am_xineplug_inp_bldvb_la_rpath = -rpath $(xineplugdir)
 xineplug_inp_cdda_la_DEPENDENCIES = $(XINE_LIB) $(am__DEPENDENCIES_1)
 am_xineplug_inp_cdda_la_OBJECTS = xineplug_inp_cdda_la-input_cdda.lo \
 	xineplug_inp_cdda_la-media_helper.lo \
@@ -242,9 +253,9 @@ CCLD = $(CC)
 LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
 	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
 	$(LDFLAGS) -o $@
-SOURCES = $(xineplug_inp_cdda_la_SOURCES) \
-	$(xineplug_inp_dvb_la_SOURCES) $(xineplug_inp_dvd_la_SOURCES) \
-	$(xineplug_inp_file_la_SOURCES) \
+SOURCES = $(xineplug_inp_bldvb_la_SOURCES) \
+	$(xineplug_inp_cdda_la_SOURCES) $(xineplug_inp_dvb_la_SOURCES) \
+	$(xineplug_inp_dvd_la_SOURCES) $(xineplug_inp_file_la_SOURCES) \
 	$(xineplug_inp_gnome_vfs_la_SOURCES) \
 	$(xineplug_inp_http_la_SOURCES) $(xineplug_inp_mms_la_SOURCES) \
 	$(xineplug_inp_net_la_SOURCES) $(xineplug_inp_pnm_la_SOURCES) \
@@ -252,9 +263,9 @@ SOURCES = $(xineplug_inp_cdda_la_SOURCES
 	$(xineplug_inp_rtsp_la_SOURCES) $(xineplug_inp_smb_la_SOURCES) \
 	$(xineplug_inp_stdin_fifo_la_SOURCES) \
 	$(xineplug_inp_v4l_la_SOURCES) $(xineplug_inp_vcdo_la_SOURCES)
-DIST_SOURCES = $(xineplug_inp_cdda_la_SOURCES) \
-	$(xineplug_inp_dvb_la_SOURCES) $(xineplug_inp_dvd_la_SOURCES) \
-	$(xineplug_inp_file_la_SOURCES) \
+DIST_SOURCES = $(xineplug_inp_bldvb_la_SOURCES) \
+	$(xineplug_inp_cdda_la_SOURCES) $(xineplug_inp_dvb_la_SOURCES) \
+	$(xineplug_inp_dvd_la_SOURCES) $(xineplug_inp_file_la_SOURCES) \
 	$(xineplug_inp_gnome_vfs_la_SOURCES) \
 	$(xineplug_inp_http_la_SOURCES) $(xineplug_inp_mms_la_SOURCES) \
 	$(xineplug_inp_net_la_SOURCES) $(xineplug_inp_pnm_la_SOURCES) \
@@ -395,6 +406,8 @@ LIBINTL = @LIBINTL@
 LIBISO9660_LIBS = @LIBISO9660_LIBS@
 LIBMAD_CFLAGS = @LIBMAD_CFLAGS@
 LIBMAD_LIBS = @LIBMAD_LIBS@
+LIBMEDIACLIENT_CFLAGS = @LIBMEDIACLIENT_CFLAGS@
+LIBMEDIACLIENT_LIBS = @LIBMEDIACLIENT_LIBS@
 LIBMODPLUG_CFLAGS = @LIBMODPLUG_CFLAGS@
 LIBMODPLUG_LIBS = @LIBMODPLUG_LIBS@
 LIBMPEG2_CFLAGS = @LIBMPEG2_CFLAGS@
@@ -614,7 +627,8 @@ in_dvd = xineplug_inp_dvd.la
 # not ported to native Windows
 @WIN32_FALSE@in_rtp = xineplug_inp_rtp.la
 @WIN32_FALSE@in_dvb = xineplug_inp_dvb.la 
-AM_CFLAGS = -D_LARGEFILE64_SOURCE $(GNOME_VFS_CFLAGS) $(ALSA_CFLAGS) $(DVD_CFLAGS)
+@WIN32_FALSE@in_bldvb = xineplug_inp_bldvb.la
+AM_CFLAGS = -D_LARGEFILE64_SOURCE $(GNOME_VFS_CFLAGS) $(ALSA_CFLAGS) $(DVD_CFLAGS) $(LIBMEDIACLIENT_CFLAGS)
 xineplug_LTLIBRARIES = \
 	xineplug_inp_file.la \
 	xineplug_inp_http.la \
@@ -631,6 +645,7 @@ xineplug_LTLIBRARIES = \
 	xineplug_inp_net.la \
 	$(in_pvr) \
 	$(in_dvb) \
+	$(in_bldvb) \
 	xineplug_inp_cdda.la
 
 xineplug_inp_file_la_SOURCES = input_file.c
@@ -673,6 +688,10 @@ xineplug_inp_dvb_la_SOURCES = input_dvb.
 xineplug_inp_dvb_la_LIBADD = $(XINE_LIB) $(PTHREAD_LIBS) $(LTLIBINTL)
 xineplug_inp_dvb_la_CFLAGS = $(VISIBILITY_FLAG) $(AM_CFLAGS)
 xineplug_inp_dvb_la_LDFLAGS = -avoid-version -module
+xineplug_inp_bldvb_la_SOURCES = input_bldvb.c net_buf_ctrl.c
+xineplug_inp_bldvb_la_LIBADD = $(LIBMEDIACLIENT_LIBS) $(XINE_LIB) $(PTHREAD_LIBS) $(LTLIBINTL)
+xineplug_inp_bldvb_la_CFLAGS = $(VISIBILITY_FLAG) $(AM_CFLAGS) $(LIBMEDIACLIENT_CFLAGS)
+xineplug_inp_bldvb_la_LDFLAGS = -avoid-version -module
 xineplug_inp_rtsp_la_SOURCES = input_rtsp.c net_buf_ctrl.c
 xineplug_inp_rtsp_la_LIBADD = $(XINE_LIB) $(PTHREAD_LIBS) $(LTLIBINTL) libreal/libreal.la librtsp/librtsp.la
 xineplug_inp_rtsp_la_CFLAGS = $(VISIBILITY_FLAG) $(AM_CFLAGS)
@@ -759,6 +778,8 @@ clean-xineplugLTLIBRARIES:
 	  echo "rm -f \"$${dir}/so_locations\""; \
 	  rm -f "$${dir}/so_locations"; \
 	done
+xineplug_inp_bldvb.la: $(xineplug_inp_bldvb_la_OBJECTS) $(xineplug_inp_bldvb_la_DEPENDENCIES) 
+	$(xineplug_inp_bldvb_la_LINK) $(am_xineplug_inp_bldvb_la_rpath) $(xineplug_inp_bldvb_la_OBJECTS) $(xineplug_inp_bldvb_la_LIBADD) $(LIBS)
 xineplug_inp_cdda.la: $(xineplug_inp_cdda_la_OBJECTS) $(xineplug_inp_cdda_la_DEPENDENCIES) 
 	$(xineplug_inp_cdda_la_LINK) -rpath $(xineplugdir) $(xineplug_inp_cdda_la_OBJECTS) $(xineplug_inp_cdda_la_LIBADD) $(LIBS)
 xineplug_inp_dvb.la: $(xineplug_inp_dvb_la_OBJECTS) $(xineplug_inp_dvb_la_DEPENDENCIES) 
@@ -800,6 +821,8 @@ distclean-compile:
 
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/input_gnome_vfs.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/net_buf_ctrl.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/xineplug_inp_bldvb_la-input_bldvb.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/xineplug_inp_bldvb_la-net_buf_ctrl.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/xineplug_inp_cdda_la-base64.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/xineplug_inp_cdda_la-input_cdda.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/xineplug_inp_cdda_la-media_helper.Plo@am__quote@
@@ -856,6 +879,20 @@ distclean-compile:
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
 @am__fastdepCC_FALSE@	$(LTCOMPILE) -c -o $@ $<
 
+xineplug_inp_bldvb_la-input_bldvb.lo: input_bldvb.c
+@am__fastdepCC_TRUE@	$(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(xineplug_inp_bldvb_la_CFLAGS) $(CFLAGS) -MT xineplug_inp_bldvb_la-input_bldvb.lo -MD -MP -MF $(DEPDIR)/xineplug_inp_bldvb_la-input_bldvb.Tpo -c -o xineplug_inp_bldvb_la-input_bldvb.lo `test -f 'input_bldvb.c' || echo '$(srcdir)/'`input_bldvb.c
+@am__fastdepCC_TRUE@	mv -f $(DEPDIR)/xineplug_inp_bldvb_la-input_bldvb.Tpo $(DEPDIR)/xineplug_inp_bldvb_la-input_bldvb.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='input_bldvb.c' object='xineplug_inp_bldvb_la-input_bldvb.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(xineplug_inp_bldvb_la_CFLAGS) $(CFLAGS) -c -o xineplug_inp_bldvb_la-input_bldvb.lo `test -f 'input_bldvb.c' || echo '$(srcdir)/'`input_bldvb.c
+
+xineplug_inp_bldvb_la-net_buf_ctrl.lo: net_buf_ctrl.c
+@am__fastdepCC_TRUE@	$(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(xineplug_inp_bldvb_la_CFLAGS) $(CFLAGS) -MT xineplug_inp_bldvb_la-net_buf_ctrl.lo -MD -MP -MF $(DEPDIR)/xineplug_inp_bldvb_la-net_buf_ctrl.Tpo -c -o xineplug_inp_bldvb_la-net_buf_ctrl.lo `test -f 'net_buf_ctrl.c' || echo '$(srcdir)/'`net_buf_ctrl.c
+@am__fastdepCC_TRUE@	mv -f $(DEPDIR)/xineplug_inp_bldvb_la-net_buf_ctrl.Tpo $(DEPDIR)/xineplug_inp_bldvb_la-net_buf_ctrl.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='net_buf_ctrl.c' object='xineplug_inp_bldvb_la-net_buf_ctrl.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(xineplug_inp_bldvb_la_CFLAGS) $(CFLAGS) -c -o xineplug_inp_bldvb_la-net_buf_ctrl.lo `test -f 'net_buf_ctrl.c' || echo '$(srcdir)/'`net_buf_ctrl.c
+
 xineplug_inp_cdda_la-input_cdda.lo: input_cdda.c
 @am__fastdepCC_TRUE@	$(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(xineplug_inp_cdda_la_CFLAGS) $(CFLAGS) -MT xineplug_inp_cdda_la-input_cdda.lo -MD -MP -MF $(DEPDIR)/xineplug_inp_cdda_la-input_cdda.Tpo -c -o xineplug_inp_cdda_la-input_cdda.lo `test -f 'input_cdda.c' || echo '$(srcdir)/'`input_cdda.c
 @am__fastdepCC_TRUE@	mv -f $(DEPDIR)/xineplug_inp_cdda_la-input_cdda.Tpo $(DEPDIR)/xineplug_inp_cdda_la-input_cdda.Plo
diff -Nupr xine-lib-1.1.16.2-original/src/input/net_buf_ctrl.c xine-lib-1.1.16.2-modified/src/input/net_buf_ctrl.c
--- xine-lib-1.1.16.2-original/src/input/net_buf_ctrl.c	2009-01-12 21:07:30.000000000 +0100
+++ xine-lib-1.1.16.2-modified/src/input/net_buf_ctrl.c	2009-05-20 18:47:56.000000000 +0200
@@ -63,7 +63,7 @@ struct nbc_s {
   int64_t          audio_fifo_length;     /* in ms */
   int64_t          video_fifo_length_int; /* in ms */
   int64_t          audio_fifo_length_int; /* in ms */
-
+  int              buffer_length;         /* in ms */
   int64_t          high_water_mark;
   /* bitrate */
   int64_t          video_last_pts;
@@ -290,6 +290,14 @@ static void nbc_put_cb (fifo_buffer_t *f
 
       if (this->buffering) {
 
+        int buffered_time = (this->video_fifo_length > this->audio_fifo_length) ? this->audio_fifo_length : this->video_fifo_length;
+	if (this->buffer_length > 0 && buffered_time > this->buffer_length) {
+          this->progress = 100;
+          report_progress(this->stream, 100);
+          this->buffering = 0;
+          nbc_set_speed_normal(this);
+        }
+
         has_video = _x_stream_info_get(this->stream, XINE_STREAM_INFO_HAS_VIDEO);
         has_audio = _x_stream_info_get(this->stream, XINE_STREAM_INFO_HAS_AUDIO);
         /* restart playing if high_water_mark is reached by all fifos
@@ -300,6 +308,7 @@ static void nbc_put_cb (fifo_buffer_t *f
          * be sure that the next buffer_pool_alloc() call will not deadlock,
          * we need at least 2 buffers (see buffer.c)
          */
+
         if ((((!has_video) || (this->video_fifo_length > this->high_water_mark)) &&
              ((!has_audio) || (this->audio_fifo_length > this->high_water_mark)) &&
              (has_video || has_audio))) {
@@ -583,3 +592,8 @@ void nbc_set_low_water_mark(nbc_t *this,
   xprintf(this->stream->xine, XINE_VERBOSITY_DEBUG,
 	  "\nnet_buf_ctrl: this method is deprecated, please fix the input plugin\n");
 }
+
+void nbc_set_buffer_length(nbc_t *this, int value) {
+  this->buffer_length = value;
+}
+
diff -Nupr xine-lib-1.1.16.2-original/src/input/net_buf_ctrl.h xine-lib-1.1.16.2-modified/src/input/net_buf_ctrl.h
--- xine-lib-1.1.16.2-original/src/input/net_buf_ctrl.h	2009-01-12 21:07:30.000000000 +0100
+++ xine-lib-1.1.16.2-modified/src/input/net_buf_ctrl.h	2009-05-20 18:48:00.000000000 +0200
@@ -33,6 +33,8 @@ void nbc_check_buffers (nbc_t *this) XIN
 
 void nbc_close (nbc_t *this);
 
+void nbc_set_buffer_length(nbc_t *this, int value);
+
 void nbc_set_high_water_mark(nbc_t *this, int value) XINE_DEPRECATED;
 
 void nbc_set_low_water_mark(nbc_t *this, int value) XINE_DEPRECATED;
